<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>å´©åï¼šæ˜Ÿç©¹é“é“è·ƒè¿è®°å½•</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-bottom: 0px;
            /* ç•™å‡ºåº•éƒ¨ç©ºéš™ */
            box-sizing: border-box;
            /* åŒ…å«padding */
            overflow: hidden;
        }

        #scroll-container {
            flex: 1 1 auto;
            /* background: rgb(243, 254, 255); */
            margin-bottom: 5px;
            overflow-y: auto;
            /* border: 1px solid #ccc; */
            border-radius: 0px 0px 10px 10px;
            position: relative;
            font-family: sans-serif;

            border-top: 1px solid rgb(214, 232, 234);
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
        }

        #scroll-container::-webkit-scrollbar {
            width: 16px;
            /* background-clip: content-box; */
        }

        #scroll-container::-webkit-scrollbar-thumb {
            background-color: rgba(68, 174, 240, 0.295);
            border-radius: 10px;
            border: 4px solid transparent;
            background-clip: content-box;
        }

        #scroll-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(43, 127, 179, 0.613);
            border-radius: 10px;
            border: 4px solid transparent;
            background-clip: content-box;
        }

        #scroll-container::-webkit-scrollbar-track {
            background: transparent;
            /* background-color: white; */
        }

        #spacer {
            height: 0;
        }

        .item {
            height: 60px;
            box-sizing: border-box;
            padding: 5px 10px;
            border-bottom: 1px solid #eee;
            position: absolute;
            width: 100%;
        }

        #filter-buttons {
            position: sticky;
            top: 0;
            background: rgb(233, 245, 246);
            z-index: 10;
            padding: 8px;

            display: flex;
            /* border: 1px solid #ccc; */
            border-radius: 10px 10px 0px 0px;
            margin-top: 8px;
            /* margin-bottom: 8px; */

            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            border-top: 1px solid #ccc;
        }

        #filter-buttons button {
            margin-right: 8px;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgb(146, 165, 168);
            background-color: #f9f9f9;
            box-shadow: rgba(141, 152, 154, 0.644) 0px 0px 4px 1px;
            box-sizing: border-box !important;
            cursor: pointer;
        }

        .active {
            position: relative;
            /* âœ… è®© ::after ç›¸å¯¹å®šä½äºè¿™ä¸ªå…ƒç´  */
            background-color: rgb(191, 245, 230) !important;
        }

        .active::after {
            content: "";
            position: absolute;
            inset: 0;
            /* border: 2px solid rgb(99, 189, 174); */
            box-shadow: 0 0 0 2px rgb(99, 189, 174);
            pointer-events: none;
            /* transition: border-width 0.3s; */
            border-radius: 8px;
        }

        #filter-buttons button:hover {
            background-color: rgb(203, 229, 230);
        }

        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            /* border: 1px solid #ccc; */
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s;
        }

        .chart-box {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 10px;
            /* margin: 2px; */
            padding: 10px;
            background-color: rgb(249, 243, 238);
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            /* aspect-ratio: 1 */
        }

        .chart {
            height: 150px;
            width: 100%;
        }

        canvas {
            width: 100% !important;
            /* å®½åº¦è‡ªåŠ¨é€‚åº” */
            height: 100% !important;
            /* é«˜åº¦è·Ÿçˆ¶å®¹å™¨ä¿æŒä¸€è‡´ */
        }

        .hide {
            display: none;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: max-content;
            background-color: rgba(0, 0, 0, 0.774);
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            /* æç¤ºæ¡†åœ¨æŒ‰é’®ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .info {
            background-color: rgb(255, 237, 209);
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            /* margin-top: 10px; */
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        .info div {
            display: flex;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
        }

        /* .info span {
            width: 100%;
            text-align: center;
        } */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <div class="info">
        <div>
            <span id="uid">UID</span>
        </div>
        <div>
            <img src="../res/102.png" style="height:80%;aspect-ratio:1;">
            <span id="special-count">é™å®šæ¶ˆè€—</span>
        </div>
        <div>
            <img src="../res/101.png" style="height:80%;aspect-ratio:1;">
            <span id="normal-count">å¸¸é©»æ¶ˆè€—</span>
        </div>
    </div>

    <div class="chart-box">
        <div class="chart-container">
            <div>è§’è‰²æ´»åŠ¨è·ƒè¿</div>
            <div class="chart">
                <canvas id="character-chart" style="height: 100px;"></canvas>
            </div>
            <div style="font-size: 14px;color:#b88b11">äº”æ˜Ÿå¹³å‡</div>
        </div>
        <div class="chart-container">
            <div>å…‰é”¥æ´»åŠ¨è·ƒè¿</div>
            <div class="chart">
                <canvas id="weapon-chart"></canvas>
            </div>
            <div style="font-size: 14px;color:#b88b11">äº”æ˜Ÿå¹³å‡</div>
        </div>
        <div class="chart-container">
            <div>å¸¸é©»è·ƒè¿</div>
            <div class="chart">
                <canvas id="normal-chart"></canvas>
            </div>
            <div style="font-size: 14px;color:#b88b11">äº”æ˜Ÿå¹³å‡</div>
        </div>
        <div class="chart-container">
            <div>æ–°æ‰‹è·ƒè¿</div>
            <div class="chart">
                <canvas id="new-chart"></canvas>
            </div>
            <div style="font-size: 14px;color:#b88b11">äº”æ˜Ÿå¹³å‡</div>
        </div>
        <div id="no-data" class="hide" style="width: 100%;text-align: center;">æš‚æ— æ•°æ®</div>
    </div>

    <div id="filter-buttons" class="buttons">
        <button data-filter="è§’è‰²æ´»åŠ¨è·ƒè¿" class="active">è§’è‰²æ´»åŠ¨è·ƒè¿</button>
        <button data-filter="å…‰é”¥æ´»åŠ¨è·ƒè¿">å…‰é”¥æ´»åŠ¨è·ƒè¿</button>
        <button data-filter="å¸¸é©»è·ƒè¿">å¸¸é©»è·ƒè¿</button>
        <button data-filter="æ–°æ‰‹è·ƒè¿">æ–°æ‰‹è·ƒè¿</button>

        <div style="display: flex; margin-left: auto;">
            <button id="selectFolderBtn" class="tooltip">
                <i class="fas fa-folder-open" style="font-size: 20px;"></i>
                <span class="tooltiptext">é€‰æ‹©æ¸¸æˆæ–‡ä»¶å¤¹ï¼Œå¦‚ path/to/Star Rail/Game/</span>
            </button>
            <button id="sync-data" class="tooltip" style="margin-right: 0px;">
                <i class="fas fa-sync-alt" style="font-size: 20px;"></i>
                <span class="tooltiptext">åŒæ­¥æ•°æ®</span>
            </button>
        </div>
    </div>

    <div id="scroll-container">
        <div id="spacer"></div>
    </div>

    <div id="selectedFolder" style="margin-bottom: 15px;text-align: center;;">
        æœªé€‰æ‹©æ¸¸æˆæ–‡ä»¶å¤¹
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script>

        var renderData;
        var specialCount = 0;
        var normalCount = 0;

        window.onload = async () => {
            await initData();
            initAverage();

            initPieChart();

            const container = document.getElementById('scroll-container');
            const spacer = document.getElementById('spacer');

            // 1. åˆ›å»ºæ‡’åŠ è½½ observer
            const imgObserver = new IntersectionObserver((entries) => {
                entries.forEach(async entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        let local = await window.utils.downloadImage(img.dataset.src); // åŠ è½½å›¾ç‰‡
                        // console.log("æœ¬åœ°å›¾ç‰‡", local)
                        img.src = local; // è®¾ç½®çœŸå® src
                        imgObserver.unobserve(img); // åªåŠ è½½ä¸€æ¬¡
                    }
                });
            }, {
                root: container,
                rootMargin: '100px', // æå‰åŠ è½½
                threshold: 0.1
            });

            let renderType = 'è§’è‰²æ´»åŠ¨è·ƒè¿';
            const itemHeight = 60;
            let items = renderData[renderType];


            const renderedItems = new Map();

            function renderItems() {

                let length = renderData[renderType]?.length;
                let totalItems = length;
                spacer.style.height = `${totalItems * itemHeight}px`;
                let visibleCount = Math.ceil(container.clientHeight / itemHeight) + 5;

                const scrollTop = container.scrollTop;
                const startIndex = Math.floor(scrollTop / itemHeight);
                const endIndex = Math.min(startIndex + visibleCount, totalItems);

                // console.log(startIndex, endIndex, startIndex, visibleCount, totalItems)

                // ç§»é™¤ä¸éœ€è¦çš„é¡¹
                for (let key of renderedItems.keys()) {
                    if (key < startIndex || key >= endIndex) {
                        const el = renderedItems.get(key);
                        container.removeChild(el);
                        renderedItems.delete(key);
                    }
                }

                // æ·»åŠ éœ€è¦æ˜¾ç¤ºçš„é¡¹
                for (let i = startIndex; i < endIndex; i++) {
                    if (!renderedItems.has(i)) {
                        const el = document.createElement('div');
                        el.className = 'item';
                        el.style.top = `${i * itemHeight}px`;
                        el.style.width = `100%`
                        el.style.display = 'flex';
                        el.style.alignItems = 'center';

                        let color = "#4caf50";
                        if (items[i].count > 70) {
                            color = "#f44336";
                        } else if (items[i].count > 50) {
                            color = "#ff9800";
                        }

                        // console.log(items[i])
                        el.innerHTML = `
                        <span style="width:48px">${items[i].count} æŠ½</span>
                        <span style="margin-left: 20px;"></span>
                        <img data-src="${items[i].icon}" style="vertical-align: middle; margin-right: 8px; height:100%;aspect-ratio:1;border-radius: 5px;background-color:#f3dc9f;" />
                        <div style="width:100%">
                            <div style="width:100%;display:flex;">
                                <span>${items[i].name}</span>
                                <span style="margin-left: auto;">${items[i].time}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" id="progressBar" style="width: ${items[i].count * 100 / 90}%;background-color: ${color};"></div>
                            </div>
                        </div>
                        `;
                        const img = el.querySelector('img');
                        imgObserver.observe(img);

                        container.appendChild(el);
                        renderedItems.set(i, el);
                    }
                }
            }

            // åˆå§‹æ¸²æŸ“
            renderItems();



            container.addEventListener('scroll', () => {
                renderItems();
            });

            let lastBtn = document.querySelector('.active');
            document.getElementById('filter-buttons').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.filter) {
                    const filterType = e.target.dataset.filter;

                    renderType = filterType;
                    items = renderData[renderType];

                    // æ¸…é™¤æ—§æ¸²æŸ“é¡¹
                    renderedItems.forEach(el => container.removeChild(el));
                    renderedItems.clear();

                    // é‡æ–°æ¸²æŸ“
                    renderItems();

                    if (lastBtn) {
                        lastBtn.classList.remove('active');
                    }
                    lastBtn = e.target;
                    lastBtn.classList.add('active');
                    console.log("æ¿€æ´»", lastBtn)
                }
            });

            let refreshBtn = document.getElementById('sync-data');
            refreshBtn.addEventListener('click', async () => {

                refreshBtn.firstElementChild.classList.add('fa-spin');
                let res = await window.utils.fetchData()
                refreshBtn.firstElementChild.classList.remove('fa-spin');

                if (!res) {
                    refreshBtn.firstElementChild.classList.add('fa-warning');
                    refreshBtn.firstElementChild.style.color = 'red';

                    setTimeout(() => {
                        alert('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å¤¹è·¯å¾„æˆ–åœ¨æ¸¸æˆä¸­é‡æ–°æ‰“å¼€è·ƒè¿å†å²');
                    }, 100);

                    setTimeout(() => {
                        refreshBtn.firstElementChild.classList.remove('fa-warning');
                        refreshBtn.firstElementChild.style.color = 'black';
                    }, 200);

                    return;
                } else {
                    //æ ·å¼å˜åŒ–
                    refreshBtn.firstElementChild.classList.add('fa-check');
                    refreshBtn.firstElementChild.style.color = 'green';

                    setTimeout(() => {
                        refreshBtn.firstElementChild.classList.remove('fa-check');
                        refreshBtn.firstElementChild.style.color = 'black';
                    }, 1000);
                }

                await initData();
                initAverage();
                initPieChart();
                initInfo();

                items = renderData[renderType];

                // æ¸…é™¤æ—§æ¸²æŸ“é¡¹
                renderedItems.forEach(el => container.removeChild(el));
                renderedItems.clear();

                // é‡æ–°æ¸²æŸ“
                renderItems();
            });

            const btn = document.getElementById('selectFolderBtn');
            const selectFolder = document.getElementById('selectedFolder');
            btn.addEventListener('click', async () => {
                // input.click(); // ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘éšè—çš„inputæ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©
                let folder = await window.utils.getFolder();
                // console.log(folder)
                if (folder) {
                    selectFolder.textContent = `å½“å‰æ¸¸æˆæ–‡ä»¶å¤¹: ${folder}`;
                }
            });

            // é¼ æ ‡æ‚¬åœæ—¶è°ƒæ•´ä½ç½®
            let btns = document.querySelectorAll('.tooltip');
            let tips = document.querySelectorAll('.tooltiptext');
            for (let i = 0; i < btns.length; i++) {
                btns[i].addEventListener('mouseenter', () => {
                    adjustTooltipPosition(tips[i]);
                });
            }

            initInfo();
        }

        async function initInfo() {
            const selectFolder = document.getElementById('selectedFolder');
            let config = await window.utils.getConfig();

            if (config.userPath) {
                selectFolder.textContent = `å½“å‰æ¸¸æˆæ–‡ä»¶å¤¹: ${config.userPath}`;
            }

            if (config.current) {
                document.getElementById('uid').textContent = `UID: ${config.current}`;
            }

            document.getElementById('special-count').textContent = `é™å®šæ¶ˆè€—: ${specialCount} æŠ½`;
            document.getElementById('normal-count').textContent = `å¸¸é©»æ¶ˆè€—: ${normalCount} æŠ½`;
        }

        async function initData() {
            const res = await window.utils.getCurrentData();
            // console.log('è¯»å–å½“å‰æ•°æ®:', res);

            // renderData = res;

            let result = {};
            specialCount = 0;
            normalCount = 0;

            for (let key in res) {
                let target;
                let icon;
                let value = res[key];
                result[key] = [];
                let count = 0;
                for (let i = 0; i < value.length; i++) {
                    let item = value[i];
                    count++;
                    if (key == "è§’è‰²æ´»åŠ¨è·ƒè¿" || key == "å…‰é”¥æ´»åŠ¨è·ƒè¿") {
                        specialCount += 1;
                    } else if (key == "å¸¸é©»è·ƒè¿" || key == "æ–°æ‰‹è·ƒè¿") {
                        normalCount += 1;
                    }
                    // console.log(item.rank_type)
                    if (item.rank_type == 5) {
                        result[key].unshift({
                            name: item.name,
                            icon: item.icon,
                            time: item.time,
                            count: count
                        });
                        count = 0;
                    }

                    if (i == value.length - 1) {
                        result[key].unshift({
                            name: "æœªå‡ºè´§",
                            icon: "../res/mark_question.png",
                            time: item.time,
                            count: count
                        });
                    }
                }
            }

            renderData = result;
            // console.log(renderData)

            // let result = res;
            // renderData = result.map(item => {
            // }
        }

        function initAverage() {

            const averageList = {
                "è§’è‰²æ´»åŠ¨è·ƒè¿": document.getElementById("character-chart").parentElement.nextElementSibling,
                "å…‰é”¥æ´»åŠ¨è·ƒè¿": document.getElementById("weapon-chart").parentElement.nextElementSibling,
                "å¸¸é©»è·ƒè¿": document.getElementById("normal-chart").parentElement.nextElementSibling,
                "æ–°æ‰‹è·ƒè¿": document.getElementById("new-chart").parentElement.nextElementSibling
            }

            for (let key in averageList) {
                let ele = averageList[key];
                // console.log(key, ele)
                let values = renderData[key];

                if (values && values?.length != 0) {
                    let average = 0;
                    for (let i = 0; i < values.length; i++) {
                        if (values[i].name == "æœªå‡ºè´§") continue;
                        average += values[i].count;
                    }
                    average = average / (values.length - 1);
                    ele.textContent = `äº”æ˜Ÿå¹³å‡: ${average.toFixed(0)} æŠ½`;

                    // console.log(average, values.length,ele)
                }
            }
        }

        async function initPieChart() {

            //åˆå§‹åŒ–æ•°æ®
            let res = await window.utils.getCurrentData();

            if (Object.keys(res).length == 0) {
                document.getElementById("no-data").classList.remove("hide");
            } else {
                document.getElementById("no-data").classList.add("hide");
            }

            let pieData = {}

            for (let key in res) {
                let value = res[key];
                pieData[key] = []

                let count = {}
                for (let i = 0; i < value.length; i++) {
                    let item = value[i];
                    if (count[item.rank_type]) {
                        count[item.rank_type] += 1;
                    } else {
                        count[item.rank_type] = 1;
                    }
                }

                pieData[key].unshift(count[5] || 0);
                pieData[key].unshift(count[4] || 0);
                pieData[key].unshift(count[3] || 0);

                // console.log(pieData[key])
            }

            let pieList = [
                {
                    chart: "character-chart",
                    data: pieData["è§’è‰²æ´»åŠ¨è·ƒè¿"]
                },
                {
                    chart: "weapon-chart",
                    data: pieData["å…‰é”¥æ´»åŠ¨è·ƒè¿"]
                },
                {
                    chart: "normal-chart",
                    data: pieData["å¸¸é©»è·ƒè¿"]
                },
                {
                    chart: "new-chart",
                    data: pieData["æ–°æ‰‹è·ƒè¿"]
                }
            ]

            for (let item of pieList) {
                // console.log(item)
                let pieId = item.chart;
                let ele = document.getElementById(pieId);
                let ctx = ele.getContext('2d');

                if (!item.data || item.data[0] == 0 && item.data[1] == 0 && item.data[2] == 0) {
                    ele.parentElement.parentElement.classList.add('hide');
                    // console.log(ele.parentElement)
                } else {
                    ele.parentElement.parentElement.classList.remove('hide');
                    // console.log(item.data);
                    let myPieChart = new Chart(ctx, {
                        type: 'pie', // æˆ– 'doughnut'
                        data: {
                            labels: ['ä¸‰æ˜Ÿ', 'å››æ˜Ÿ', 'äº”æ˜Ÿ'],
                            datasets: [{
                                data: item.data,
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(255, 206, 86, 0.7)'
                                ],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            maintainAspectRatio: false, // âœ… å…è®¸é«˜åº¦å›ºå®š
                            layout: {
                                padding: {
                                    top: 20,
                                    bottom: 0,
                                    left: 40,   // å·¦å³æ ¹æ®æ ‡ç­¾å¤–æ‰©è°ƒæ•´
                                    right: 40
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const total = context.chart._metasets[0].total;
                                            const value = context.raw;
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${context.label}: ${value} ä¸ª (${percentage}%)`;
                                        }
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 8,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                datalabels: {
                                    formatter: (value, ctx) => {
                                        let sum = ctx.chart._metasets[0].total;
                                        let percentage = (value * 100 / sum).toFixed(1) + "%";
                                        return percentage;
                                    },
                                    color: '#000',
                                    anchor: 'end', // ğŸ‘‰ æ ‡ç­¾é”šç‚¹ä½ç½®
                                    align: 'end',  // ğŸ‘‰ æ ‡ç­¾å¯¹é½æ–¹å¼ï¼ˆæ§åˆ¶æ˜¾ç¤ºåœ¨å¤–é¢ï¼‰
                                    offset: -6,    // ğŸ‘‰ æ ‡ç­¾ä¸é¥¼å›¾ä¹‹é—´çš„è·ç¦»
                                }
                            }
                        },
                        plugins: [ChartDataLabels]
                    });
                }
            }
        }

        function adjustTooltipPosition(tooltip) {
            tooltip.style.left = '50%';  // å…ˆæ¢å¤é»˜è®¤æ°´å¹³å±…ä¸­
            tooltip.style.right = 'auto';

            const rect = tooltip.getBoundingClientRect();
            const padding = 10; // è·ç¦»çª—å£è¾¹ç¼˜çš„æœ€å°è·ç¦»

            // å³è¾¹è¶…å‡ºè§†å£
            if (rect.right > window.innerWidth - padding) {
                const overflowRight = rect.right - window.innerWidth + padding;
                // å¾€å·¦ç§»åŠ¨tooltip
                tooltip.style.left = `calc(50% - ${overflowRight}px)`;
            }

            // å·¦è¾¹è¶…å‡ºè§†å£
            if (rect.left < padding) {
                tooltip.style.left = `${padding}px`;
            }
        }
    </script>

</body>

</html>